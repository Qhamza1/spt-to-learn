<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPT LEARN | المنصة الشاملة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary: #6366f1; --secondary: #8b5cf6;
            --bg: #0f172a; --card: rgba(255, 255, 255, 0.05);
            --text: #ffffff; --input: rgba(0,0,0,0.3);
        }
        .light-mode {
            --bg: #f1f5f9; --card: rgba(255, 255, 255, 0.9);
            --text: #1e293b; --input: #ffffff;
        }
        * { box-sizing: border-box; transition: 0.3s; }
        body { margin: 0; font-family: 'Cairo', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; justify-content: center; align-items: center; }

        /* Splash Screen */
        #splash-screen { position: fixed; inset: 0; background: #0f172a; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .fade-out { opacity: 0; visibility: hidden; }

        .container { width: 92%; max-width: 500px; background: var(--card); backdrop-filter: blur(20px); border-radius: 35px; padding: 30px; border: 1px solid rgba(128,128,128,0.2); position: relative; margin: 20px 0; }
        .header-btns { position: absolute; top: 25px; left: 25px; right: 25px; display: flex; justify-content: space-between; }
        .icon-btn { width: 42px; height: 42px; border-radius: 14px; border: none; background: var(--primary); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: 1px solid rgba(128,128,128,0.2); background: var(--input); color: var(--text); outline: none; font-family: 'Cairo'; }
        .btn-action { width: 100%; padding: 15px; border-radius: 15px; border: none; color: white; font-weight: 700; cursor: pointer; background: linear-gradient(135deg, var(--primary), var(--secondary)); display: flex; align-items: center; justify-content: center; gap: 10px; margin-top: 10px; }
        
        #custom-alert { position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-150%); background: var(--primary); color: white; padding: 12px 25px; border-radius: 15px; z-index: 10000; transition: 0.5s; }
        #custom-alert.show { transform: translateX(-50%) translateY(0); }

        .hidden { display: none !important; }
        .screen { animation: screenIn 0.5s ease; text-align: center; }
        @keyframes screenIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .report-card { background: white; color: #1e293b; padding: 20px; border-radius: 20px; text-align: right; border: 2px solid var(--primary); }
    </style>
</head>
<body>

<div id="custom-alert"></div>

<div id="splash-screen">
    <div style="font-size: 5rem; color: var(--primary);"><i class="fas fa-graduation-cap"></i></div>
    <h2 style="color:white; margin-top:10px;">SPT <span style="color:var(--primary)">LEARN</span></h2>
</div>

<div class="container">
    <div class="header-btns">
        <button class="icon-btn" onclick="toggleTheme()"><i class="fas fa-moon" id="theme-icon"></i></button>
        <button class="icon-btn" id="prof-btn" style="display:none" onclick="showScreen('profile-screen')"><i class="fas fa-user"></i></button>
    </div>

    <div id="main-menu" class="screen">
        <br><br><div style="font-size: 3.5rem; color: var(--primary);"><i class="fas fa-graduation-cap"></i></div>
        <h1>SPT <span style="color:var(--primary)">LEARN</span></h1>
        <p style="opacity: 0.7">نظام الإدارة التعليمية المتطور</p>
        <div style="margin-top: 25px; display: grid; gap: 10px;">
            <button class="btn-action" onclick="openAuth('teacher')">بوابة المعلم</button>
            <button class="btn-action" style="background:#334155" onclick="openAuth('parent')">بوابة ولي الأمر</button>
            <button class="btn-action" style="background:none; border:1px solid var(--primary)" onclick="shareApp()">مشاركة المنصة</button>
        </div>
    </div>

    <div id="profile-screen" class="screen hidden">
        <br><br><h3>بيانات الحساب</h3>
        <div style="background:var(--primary); padding:20px; border-radius:20px; color:white; margin:15px 0; text-align: right; font-size: 0.9rem;">
            <p><i class="fas fa-user"></i> <b>ولي الأمر:</b> <span id="u-name"></span></p>
            <p><i class="fas fa-child"></i> <b>الطالب المرتبط:</b> <span id="u-student"></span></p>
            <p><i class="fas fa-envelope"></i> <b>البريد:</b> <span id="u-email"></span></p>
            <p><i class="fas fa-phone"></i> <b>الهاتف:</b> <span id="u-phone"></span></p>
        </div>
        <button class="btn-action" style="background:var(--danger)" onclick="handleLogout()">تسجيل الخروج</button>
        <button class="btn-action" style="background:none; color:var(--text)" onclick="backToDash()">رجوع</button>
    </div>

    <div id="teacher-dash" class="screen hidden">
        <br><br><h3>إضافة تقرير طالب</h3>
        <input type="text" id="s-name" placeholder="اسم الطالب الثلاثي">
        <input type="text" id="p-name" placeholder="اسم ولي الأمر">
        <select id="s-grade">
            <option>ممتاز جداً ⭐⭐⭐⭐⭐</option>
            <option>جيد جداً ⭐⭐⭐⭐</option>
            <option>جيد ⭐⭐⭐</option>
        </select>
        <textarea id="s-note" rows="2" placeholder="ملاحظات المعلم..."></textarea>
        <button class="btn-action" onclick="saveReport()"><i class="fas fa-save"></i> حفظ التقرير</button>
        <div id="history-list" style="margin-top:20px; max-height:100px; overflow-y:auto; font-size:0.8rem"></div>
    </div>

    <div id="parent-dash" class="screen hidden">
        <br><br><h3>استعلام النتائج</h3>
        <input type="text" id="search-code" placeholder="أدخل كود الطالب">
        <button class="btn-action" onclick="getReport()">بحث</button>
        <div id="report-view" class="hidden">
            <div id="capture-area" style="margin-top:15px">
                <div class="report-card">
                    <h3 id="v-name" style="margin:0; color:var(--primary)"></h3>
                    <p>ولي الأمر: <b id="v-parent"></b></p>
                    <hr style="opacity:0.1">
                    <p>التقييم: <b id="v-grade"></b></p>
                    <p>الملاحظات: <span id="v-note"></span></p>
                    <small style="opacity:0.5" id="v-date"></small>
                </div>
            </div>
            <button class="btn-action" style="background:#475569" onclick="downloadImg()">تحميل كصورة</button>
        </div>
        <button class="btn-action" style="background:none; margin-top:15px; color:var(--text)" onclick="handleLogout()">خروج</button>
    </div>

    <div id="auth-screen" class="screen hidden">
        <br><br><h3 id="auth-title">دخول</h3>
        <div id="signup-fields" class="hidden">
            <input type="text" id="reg-fullname" placeholder="الاسم الثلاثي لولي الأمر">
            <input type="text" id="reg-studentname" placeholder="اسم الطالب الثلاثي">
            <input type="tel" id="reg-phone" placeholder="رقم هاتف التواصل">
        </div>
        <input type="email" id="auth-email" placeholder="البريد الإلكتروني">
        <input type="password" id="auth-pass" placeholder="كلمة المرور">
        <button class="btn-action" onclick="handleAuth()">تأكيد</button>
        <p id="auth-toggle" onclick="toggleAuthMode()" style="cursor:pointer; font-size: 0.8rem; margin-top:15px;"></p>
        <button class="btn-action" style="background:none; color:var(--text)" onclick="showScreen('main-menu')">رجوع</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, onAuthStateChanged, updateProfile, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBmjOSQ9VlpKqs-V2IXEY_tWLjCSluQuGE",
      authDomain: "spt-to-learn.firebaseapp.com",
      databaseURL: "https://spt-to-learn-default-rtdb.firebaseio.com",
      projectId: "spt-to-learn",
      storageBucket: "spt-to-learn.firebasestorage.app",
      messagingSenderId: "122536294060",
      appId: "1:122536294060:web:74353a633191a48d231109"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    let authMode = "login";
    let userRole = localStorage.getItem('userRole') || "";

    window.addEventListener('load', () => { setTimeout(() => document.getElementById('splash-screen').classList.add('fade-out'), 2000); });
    window.toggleTheme = () => { document.body.classList.toggle('light-mode'); };
    window.showAlert = (msg) => { const a = document.getElementById('custom-alert'); a.innerText = msg; a.classList.add('show'); setTimeout(() => a.classList.remove('show'), 3000); };
    window.showScreen = (id) => { document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); };

    window.openAuth = (role) => { userRole = role; localStorage.setItem('userRole', role); authMode = "login"; updateAuthUI(); showScreen('auth-screen'); };
    
    function updateAuthUI() { 
        document.getElementById('auth-title').innerText = authMode === 'login' ? 'تسجيل الدخول' : 'حساب جديد';
        document.getElementById('auth-toggle').innerText = authMode === 'login' ? 'ليس لديك حساب؟ سجل هنا' : 'لديك حساب؟ ادخل من هنا';
        authMode === 'signup' ? document.getElementById('signup-fields').classList.remove('hidden') : document.getElementById('signup-fields').classList.add('hidden');
    }

    window.toggleAuthMode = () => { authMode = (authMode === 'login' ? 'signup' : 'login'); updateAuthUI(); };

    window.handleAuth = () => {
        const e = document.getElementById('auth-email').value;
        const p = document.getElementById('auth-pass').value;
        if(authMode === 'signup') {
            const name = document.getElementById('reg-fullname').value;
            const sname = document.getElementById('reg-studentname').value;
            const phone = document.getElementById('reg-phone').value;
            if(!name || !sname || !phone) return showAlert("يرجى إكمال كافة البيانات");
            
            createUserWithEmailAndPassword(auth, e, p).then((res) => {
                updateProfile(res.user, { displayName: name });
                set(ref(db, 'users/' + res.user.uid), { phone: phone, student: sname, role: userRole });
                sendEmailVerification(res.user);
                showAlert("تم! فعل حسابك من الإيميل");
                authMode = "login"; updateAuthUI();
            }).catch(() => showAlert("خطأ في البيانات"));
        } else {
            signInWithEmailAndPassword(auth, e, p).then((res) => {
                if(!res.user.emailVerified) { showAlert("فعل حسابك أولاً"); signOut(auth); }
            }).catch(() => showAlert("خطأ في تسجيل الدخول"));
        }
    };

    onAuthStateChanged(auth, (user) => {
        if(user && user.emailVerified) {
            document.getElementById('prof-btn').style.display = "flex";
            document.getElementById('u-name').innerText = user.displayName;
            document.getElementById('u-email').innerText = user.email;
            get(child(ref(db), 'users/' + user.uid)).then(s => { 
                if(s.exists()){
                    document.getElementById('u-phone').innerText = s.val().phone;
                    document.getElementById('u-student').innerText = s.val().student;
                }
            });
            userRole === 'teacher' ? showScreen('teacher-dash') : showScreen('parent-dash');
        } else {
            document.getElementById('prof-btn').style.display = "none";
            showScreen('main-menu');
        }
    });

    window.handleLogout = () => { localStorage.removeItem('userRole'); signOut(auth); };
    window.backToDash = () => userRole === 'teacher' ? showScreen('teacher-dash') : showScreen('parent-dash');

    window.saveReport = () => {
        const n = document.getElementById('s-name').value;
        const pn = document.getElementById('p-name').value;
        const c = 'SPT-' + Math.floor(1000 + Math.random() * 9000);
        if(!n || !pn) return showAlert("أكمل البيانات");
        set(ref(db, 'students/' + c), { 
            name: n, parent: pn, grade: document.getElementById('s-grade').value, 
            note: document.getElementById('s-note').value, date: new Date().toLocaleDateString('ar-EG') 
        }).then(() => { 
            showAlert("تم الحفظ! الكود: " + c); 
            document.getElementById('s-name').value = ""; document.getElementById('p-name').value = "";
        });
    };

    window.getReport = () => {
        const c = document.getElementById('search-code').value.trim();
        get(child(ref(db), 'students/' + c)).then(s => {
            if(s.exists()) {
                const d = s.val();
                document.getElementById('v-name').innerText = d.name;
                document.getElementById('v-parent').innerText = d.parent;
                document.getElementById('v-grade').innerText = d.grade;
                document.getElementById('v-note').innerText = d.note;
                document.getElementById('v-date').innerText = d.date;
                document.getElementById('report-view').classList.remove('hidden');
            } else { showAlert("الكود غير موجود"); }
        });
    };

    window.downloadImg = () => html2canvas(document.getElementById('capture-area')).then(c => { const a = document.createElement('a'); a.download = 'report.png'; a.href = c.toDataURL(); a.click(); });
    window.shareApp = () => navigator.share ? navigator.share({ title: 'SPT LEARN', url: window.location.href }) : alert("انسخ الرابط");
</script>
</body>
</html>